<style>
  [v-cloak] {
    display: none;
  }
</style>

<div v-scope v-cloak id="katapp">
    <button type="button" @click="handlers.makeElection">Make Election</button>
	<div>Name: {{rbl.value('rbl-value', 'nameFirst', 'value')}}</div>
	<div>Savanna: {{rbl.value('rbl-value', 's-hw/info_MEDICAL_00.html | hw/info_MEDICAL.html', 'value') ?? "N/A"}}</div>
	<div v-for="coverage in rbl.source('electionSummary')" :key="coverage.index" :key-off="coverage.currentCode">
		<div v-scope="{
			get optionId() { return coverage.benefitType + '-' + (coverage.optionId || '').padStart(2,'0'); },
			get optionSavannaId() { return `${coverage.benefitType}_${(coverage.optionId || '').padStart(2,'0')}`; },
			helpfulInfo: function(caller) {
			  const rows = rbl.source('helpfulInfo');
			  const result = rows.find(r => r.index == this.optionId);
			  if (coverage.benefitType == 'MEDICAL') {
				console.log('helpfulInfo', caller, this.optionId, result != undefined);
			  }
			  return result;
			},
			get hasSavannaContent() { 
			  // return false; 
			  return rbl.value('rbl-value', `s-hw/info_${this.optionSavannaId}.html | hw/info_${coverage.benefitType}.html`, 'value') == '1'; 
			},
			get showSummaryLink() { return ( this.helpfulInfo('SCOPE: showSummaryLink')?.summaryLink ?? '0' ) != '0'; },
			showMoreOptions: function(caller) { 
			  if (coverage.benefitType == 'MEDICAL') {
				  console.log('showMoreOptions', caller, this.optionId, this.hasSavannaContent, this.showSummaryLink);
			  }
			  return this.hasSavannaContent || this.showSummaryLink; 
			}
		  }">
			  
			<div>Benefit: {{coverage.benefitName}}</div>
			<div>Coverage: {{coverage.currentCode}}</div>
			<div>Cost: {{coverage.eeCost}}</div>
			<br/>
			<div>HelpfulInfo Exists: {{helpfulInfo("HTML: HelpfulInfo Exists") != undefined}}</div>
			<br/>
			More Options: {{showMoreOptions("HTML: More Options")}}<br/>
			More Options Inline: {{rbl.value('rbl-value', `s-hw/info_${`${coverage.benefitType}_${(coverage.optionId || '').padStart(2,'0')}`}.html | hw/info_${coverage.benefitType}.html`, 'value') == '1' || ( helpfulInfo('HTML: More Options Inline')?.summaryLink ?? '0' ) != '0'}}<br/>
			More Options rbl.source(helpfulInfo): {{rbl.value('rbl-value', 's-hw/info_MEDICAL_03.html | hw/info_MEDICAL.html', 'value') == '1' || ( rbl.source('helpfulInfo').find(r => r.index == coverage.benefitType + '-' + (coverage.optionId || '').padStart(2,'0'))?.summaryLink ?? '0' ) != '0'}}<br/>
			More Options Global: {{rbl.value('rbl-value', 's-hw/info_MEDICAL_03.html | hw/info_MEDICAL.html', 'value') == '1' || ( rbl.source('helpfulInfo').find(r => r.index == rbl.source('electionSummary').find( r => r.index == 'MEDICAL').benefitType + '-' + (rbl.source('electionSummary').find( r => r.index == 'MEDICAL').optionId || '').padStart(2,'0'))?.summaryLink ?? '0' ) != '0'}}<br/>
			<br/>
		</div>
	</div>

	<pre>{{JSON.stringify(rbl.results, null, 2)}}</pre>
</div>

<script type="text/javascript" src="https://unpkg.com/petite-vue@0.4.1/dist/petite-vue.iife.js"></script>

<script type="text/javascript">
	const pushToTables = [];

	const state = PetiteVue.reactive({
		rbl: {
			results: { },

			source(tableName) { return this.results[tableName] ?? []; },
			value(tableName, keyValue, columnName) { return this.source(tableName).find( r => r.id == keyValue )?.[columnName ?? "value"]; },

			pushTo(table, rows) {
				if ( this.results[table] == undefined ) {
					this.results = Object.assign({}, this.results, { [table]: [] });
				}
				const t = this.results[table] ?? ( this.results[table] = []);
				const toPush = rows instanceof Array ? rows : [rows];

				toPush.forEach((row, i) => {
					row.id = row.id ?? "_pushId_" + (t.length + i);

					const index = t.findIndex(r => r.id == row.id);
					if (index > -1) {
						// t.splice(index, 1, row);
						t[index] = row;
					}
					else {
						// t.splice(t.length, 0, row);
						t.push(row);
					}
				});
				pushToTables.push(table);
			},
		},
		handlers: {
			makeElection: async function() { 
				await calculateAsync(false); 
			}
		}
	});

	const app = PetiteVue.createApp(state);

	function copyTabDefToRblState(tableName, rows) {
		state.rbl.results = Object.assign({}, state.rbl.results, { [tableName]: rows });
		// state.rbl.results[tableName] = rows;
	}
    function mergeTableToRblState(tableName, rows) {
		if (state.rbl.results[tableName] == undefined) {
			state.rbl.results = Object.assign({}, state.rbl.results, { [tableName]: [] });
			// state.rbl.results[tableName] = [];
        }

		rows.forEach(row => {
            if (tableName == "rbl-skip") {
                row["@id"] = row.key;
                if (row.value == undefined) {
                    row.value = "1";
                }
            }
            const index = state.rbl.results[tableName].findIndex(r => r.id == row.id);
            if (index > -1) {
				// state.rbl.results[tableName].splice(index, 1, Object.assign({}, state.rbl.results[tableName][index], row));
				state.rbl.results[tableName][index] = row;
            }
            else {
				// state.rbl.results[tableName].splice(state.rbl.results[tableName].length, 0, row);
				state.rbl.results[tableName].push(row);
            }
        });
        state.rbl.results[tableName] = state.rbl.results[tableName].filter(r => r.on != "0");
    }
	
	async function calculateAsync(firstCalc) {
		// Simulate calculation api call...
		await new Promise(resolve => setTimeout(resolve, 250));
		console.log("Calculation done, firstCalc: " + firstCalc)

		const rblValueRows = [ { id: "nameFirst", value: firstCalc ? "John" : "John 2" } ];

		if ( firstCalc && pushToTables.indexOf("rbl-value") == -1 ) {
			mergeTableToRblState("rbl-value", rblValueRows);
		}

		copyTabDefToRblState("helpfulInfo", [ { id: "6", index: "MEDICAL-03", summaryLink: "/client_docs/010/en_us/hw/SAI-0103-2024-ENG-XXXX-SBC.pdf" } ]);

		copyTabDefToRblState("electionSummary", [ {
			"id": "1",
			"benefitType": "MEDICAL",
			"index": "MEDICAL",
			"groupId": "1",
			"benefitName": "Medical",
			"eeCost":  firstCalc ? "$0.00" : "$146.60",
			"currentCode": firstCalc ? "MEDICAL-00-00" : "MEDICAL-03-01",
			"optionId": firstCalc ? "00" : "03"
		} ]);

		/*
		await PetiteVue.nextTick(() => {
			if ( pushToTables.indexOf("rbl-value") > -1 ) {
				mergeTableToRblState("rbl-value", rblValueRows);
			}
		});
		*/
	}

	async function simulateSavannaAsync() {
		// Simulate savanna api call...
		await new Promise(resolve => setTimeout(resolve, 500));
		console.log("Savanna api done")
		// await PetiteVue.nextTick(() => state.rbl.pushTo("rbl-value", [ { id: "s-hw/info_MEDICAL_00.html | hw/info_MEDICAL.html", value: "0" } ]));
		state.rbl.pushTo("rbl-value", [ { id: "s-hw/info_MEDICAL_00.html | hw/info_MEDICAL.html", value: "0" } ]);
	}

	async function mountAsync() {
		await calculateAsync(true);

		app.mount("#katapp");
		
		await simulateSavannaAsync();
	}

	mountAsync();
</script>